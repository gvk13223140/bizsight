{% extends "base.html" %}
{% block title %}Create Bill | BizSight{% endblock %}

{% block content %}

<h1 style="margin-bottom:6px;">Create New Bill</h1>
<p style="color:#6B7280; margin-bottom:24px;">
  Fill the details below to generate a bill
</p>

<form method="post" action="{% url 'create_bill' %}">
{% csrf_token %}

  <!-- ================= CUSTOMER DETAILS ================= -->
  <div class="card">
    <h3 style="margin-bottom:12px;">Customer Details (Optional)</h3>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
      <div>
        <label>Customer Name</label>
        <input type="text" name="customer_name" placeholder="Enter customer name">
      </div>

      <div>
        <label>Phone Number</label>
        <input type="text" name="customer_phone" placeholder="Enter phone number">
      </div>

      <div>
        <label>
          Email
          <span id="emailRequiredText" style="color:red; display:none;">
            (Required for bills above â‚¹5000)
          </span>
        </label>
        <input type="email" name="customer_email" id="customerEmail"
               placeholder="Enter email address">
      </div>

      <div>
        <label>Address</label>
        <textarea name="customer_address"
                  placeholder="Enter address (optional)"
                  rows="2"></textarea>
      </div>
    </div>
  </div>

  <br>

  <!-- ================= BILL ITEMS ================= -->
  <div class="card">
    <h3 style="margin-bottom:12px;">Bill Items</h3>

    <table class="invoice-table" id="itemsTable">
      <thead>
        <tr>
          <th>Item Name</th>
          <th width="80">Qty</th>
          <th width="120">Price (â‚¹)</th>
          <th width="120">Total (â‚¹)</th>
          <th width="40"></th>
        </tr>
      </thead>
      <tbody id="itemsBody">
        <tr>
          <td><input type="text" name="item_name[]" placeholder="Item name" required></td>
          <td><input type="number" name="quantity[]" value="1" min="1"></td>
          <td><input type="number" name="price[]" value="0" min="0"></td>
          <td class="row-total">0</td>
          <td><button type="button" onclick="removeRow(this)">âœ•</button></td>
        </tr>
      </tbody>
    </table>

    <button type="button" class="btn btn-secondary" style="margin-top:12px;" onclick="addRow()">
      + Add Item
    </button>
  </div>

  <br>

  <!-- ================= PAYMENT DETAILS ================= -->
  <div class="card">
    <h3 style="margin-bottom:12px;">Payment Details</h3>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
      <div>
        <label>Payment Status</label>
        <select name="payment_status">
          <option value="PAID">Paid</option>
          <option value="UNPAID">Unpaid</option>
          <option value="PAY_LATER">Pay Later</option>
        </select>
      </div>

      <div>
        <label>Discount (â‚¹)</label>
        <input type="number" name="discount" id="discount" value="0" min="0">
      </div>
    </div>
  </div>

  <br>

  <!-- ================= SUMMARY ================= -->
  <div class="card">
    <h3>Summary</h3>

    <div style="display:flex; justify-content:space-between; margin-top:8px;">
      <span>Subtotal</span>
      <strong>â‚¹<span id="subtotal">0</span></strong>
    </div>

    <div style="display:flex; justify-content:space-between;">
      <span>Discount</span>
      <strong>- â‚¹<span id="discountValue">0</span></strong>
    </div>

    <hr>

    <div style="display:flex; justify-content:space-between; font-size:18px;">
      <strong>Total</strong>
      <strong>â‚¹<span id="grandTotal">0</span></strong>
    </div>
  </div>

  <br>

  <!-- ================= ACTION ================= -->
  <div style="text-align:right;">
    <button type="submit" class="btn btn-primary">
      Generate Bill
    </button>
  </div>
</form>

<!-- ================= JS ================= -->
<script>
function recalc() {
  let subtotal = 0;

  document.querySelectorAll("#itemsBody tr").forEach(row => {
    const qty = +row.querySelector('[name="quantity[]"]').value || 0;
    const price = +row.querySelector('[name="price[]"]').value || 0;
    const total = qty * price;

    row.querySelector(".row-total").innerText = total;
    subtotal += total;
  });

  document.getElementById("subtotal").innerText = subtotal;

  const discount = +document.getElementById("discount").value || 0;
  document.getElementById("discountValue").innerText = discount;

  const grandTotal = Math.max(0, subtotal - discount);
  document.getElementById("grandTotal").innerText = grandTotal;

  // ðŸ”’ EMAIL REQUIRED LOGIC
  const emailInput = document.getElementById("customerEmail");
  const emailText = document.getElementById("emailRequiredText");

  if (grandTotal > 5000) {
    emailInput.required = true;
    emailText.style.display = "inline";
  } else {
    emailInput.required = false;
    emailText.style.display = "none";
  }
}

function addRow() {
  const row = document.querySelector("#itemsBody tr").cloneNode(true);
  row.querySelectorAll("input").forEach(input => {
    if (input.name.includes("quantity")) input.value = 1;
    else input.value = "";
  });
  row.querySelector(".row-total").innerText = "0";
  document.getElementById("itemsBody").appendChild(row);
}

function removeRow(btn) {
  const rows = document.querySelectorAll("#itemsBody tr");
  if (rows.length > 1) {
    btn.closest("tr").remove();
    recalc();
  }
}

document.addEventListener("input", recalc);
</script>

<style>
input, select, textarea {
  width:100%;
  padding:8px;
  border:1px solid #E5E7EB;
  border-radius:4px;
}

.invoice-table {
  width:100%;
  border-collapse:collapse;
}

.invoice-table th,
.invoice-table td {
  border:1px solid #E5E7EB;
  padding:8px;
  text-align:left;
}

.card {
  background:white;
  border:1px solid #E5E7EB;
  border-radius:8px;
  padding:16px;
}
</style>

{% endblock %}
