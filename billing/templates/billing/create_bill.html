{% extends "base.html" %}
{% block title %}Create Bill | BizSight{% endblock %}
{% block navbar %}
  {% include "partials/navbar.html" %}
{% endblock %}

{% block content %}

<h1 style="color:#0A1F44; margin-bottom:8px;">Create New Bill</h1>
<p style="color:#6B7280; margin-bottom:20px;">Generate a new customer bill</p>

<div id="formError" style="display:none;color:#B91C1C;margin-bottom:12px;font-weight:600;"></div>

<form method="post" action="{% url 'create_bill' %}" onsubmit="return validateBillForm()">
{% csrf_token %}

<div class="card">
  <h3>Customer Details</h3>
  <input name="customer_name" placeholder="Customer name" class="form-input">
  <input name="customer_phone" placeholder="Phone" class="form-input">
  <input name="customer_email" id="emailField" placeholder="Email" class="form-input">
  <textarea name="customer_address" placeholder="Address" class="form-input"></textarea>
</div>

<div class="card">
  <h3>Items</h3>
  <table class="invoice-table" id="items">
    <thead>
      <tr>
        <th>Item</th><th>Qty</th><th>Price</th><th>Total</th><th></th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input name="item_name[]" required class="form-input"></td>
        <td><input name="quantity[]" type="number" value="1" class="form-input"></td>
        <td><input name="price[]" type="number" value="0" class="form-input"></td>
        <td class="row-total">0</td>
        <td><button type="button" class="btn btn-danger" onclick="removeRow(this)">✕</button></td>
      </tr>
    </tbody>
  </table>
  <button type="button" class="btn btn-secondary" onclick="addRow()">+ Add Item</button>
</div>

<div class="card">
  <h3>Payment</h3>
  <select name="payment_status" class="form-input">
    <option value="PAID">Paid</option>
    <option value="UNPAID">Unpaid</option>
    <option value="PAY_LATER">Pay Later</option>
  </select>

  <select name="payment_mode" class="form-input">
    <option value="CASH">Cash</option>
    <option value="UPI">UPI</option>
  </select>

  <input type="number" name="discount" id="discount" value="0" placeholder="Discount" class="form-input">
</div>

<div class="card total-card">
  <h3>Total</h3>
  <p>Subtotal: ₹<span id="subtotal">0</span></p>
  <p>Discount: ₹<span id="discountValue">0</span></p>
  <h2 style="color:#0A1F44;">₹<span id="grandTotal">0</span></h2>
</div>

<div style="text-align:right;">
  <button class="btn btn-primary">Generate Bill</button>
</div>

</form>

<style>
.card {
  background:#fff;
  border:1px solid #E5E7EB;
  border-radius:10px;
  padding:18px;
  margin-bottom:20px;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
}
.card h3 {
  margin-bottom:12px;
  color:#0A1F44;
}
.form-input {
  display:block;
  width:100%;
  margin-bottom:10px;
  padding:8px;
  border:1px solid #E5E7EB;
  border-radius:6px;
}
.invoice-table {
  width:100%;
  border-collapse:collapse;
  margin-bottom:12px;
}
.invoice-table th {
  background:#0A1F44;
  color:#fff;
  padding:8px;
}
.invoice-table td {
  border:1px solid #E5E7EB;
  padding:6px;
}
.btn {
  padding:6px 12px;
  border-radius:6px;
  font-weight:600;
  cursor:pointer;
  border:none;
}
.btn-primary {
  background:#0A1F44;
  color:#fff;
}
.btn-primary:hover { background:#14356b; }
.btn-secondary {
  background:#e6ecf5;
  color:#0A1F44;
}
.btn-secondary:hover { background:#d0d7e6; }
.btn-danger {
  background:#FEE2E2;
  color:#991B1B;
}
.btn-danger:hover { background:#fca5a5; }
.total-card h2 {
  margin-top:10px;
  font-size:22px;
}
</style>

<!-- SCRIPT -->
<script>
function recalc() {
  let subtotal = 0;
  document.querySelectorAll("#items tbody tr").forEach((row) => {
    const q = +row.querySelector('[name="quantity[]"]').value || 0;
    const p = +row.querySelector('[name="price[]"]').value || 0;
    const t = q * p;
    row.querySelector(".row-total").innerText = t;
    subtotal += t;
  });
  const discount = +document.getElementById("discount").value || 0;
  const total = Math.max(0, subtotal - discount);
  document.getElementById("subtotal").innerText = subtotal;
  document.getElementById("discountValue").innerText = discount;
  document.getElementById("grandTotal").innerText = total;
  const email = document.getElementById("emailField").value.trim();
  const errorBox = document.getElementById("formError");
  if (total >= 5000 && !email) {
    errorBox.style.display = "block";
    errorBox.innerText = "Customer email is required for bills above ₹5,000";
  } else {
    errorBox.style.display = "none";
  }
}
document.addEventListener("input", recalc);
function addRow(){
  const r=document.querySelector("#items tbody tr:last-child").cloneNode(true);
  r.querySelectorAll("input").forEach(i=>i.value="");
  r.querySelector(".row-total").innerText=0;
  document.querySelector("#items tbody").appendChild(r);
}
function removeRow(b){
  if(document.querySelectorAll("#items tbody tr").length>1){
    b.closest("tr").remove();
    recalc();
  }
}
function validateBillForm() {
  const total = +document.getElementById("grandTotal").innerText;
  const email = document.getElementById("emailField").value.trim();
  if (total >= 5000 && !email) {
    alert("Customer email is required for bills above ₹5,000");
    return false;
  }
  return true;
}
</script>
{% endblock %}
