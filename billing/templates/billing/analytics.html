{% extends "base.html" %}
{% block title %}Analytics | BizSight{% endblock %}
{% block navbar %}
  {% include "partials/navbar.html" %}
{% endblock %}

{% block content %}
<div style="margin-bottom:20px;">
  <div class="dropdown" style="display:inline-block;position:relative;">
    <button class="btn btn-primary">Download</button>
    <div class="dropdown-menu" style="
        position:absolute;
        background:#fff;
        border:1px solid #ddd;
        border-radius:6px;
        box-shadow:0 4px 12px rgba(0,0,0,0.08);
        display:none;
        min-width:160px;
        z-index:1000;">
      <a href="{% url 'download_sales_csv' %}?from_date={{ from_date }}&to_date={{ to_date }}" class="dropdown-item">CSV</a>
      <a href="{% url 'download_sales_excel' %}?from_date={{ from_date }}&to_date={{ to_date }}" class="dropdown-item">Excel</a>
      <a href="{% url 'download_sales_pdf' %}?from_date={{ from_date }}&to_date={{ to_date }}" class="dropdown-item">PDF</a>
    </div>
  </div>
</div>

<style>
  .dropdown-menu a {
    display:block;
    padding:8px 12px;
    color:#0A1F44;
    text-decoration:none;
  }
  .dropdown-menu a:hover {
    background:#eef2f9;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const btn = document.querySelector(".dropdown .btn");
    const menu = document.querySelector(".dropdown-menu");
    btn.addEventListener("click", function() {
      menu.style.display = menu.style.display === "block" ? "none" : "block";
    });
    document.addEventListener("click", function(e) {
      if (!btn.contains(e.target) && !menu.contains(e.target)) {
        menu.style.display = "none";
      }
    });
  });
</script>

<h1 style="color:#0A1F44; margin-bottom:8px;">Analytics</h1>
<p style="color:#6B7280; margin-bottom:20px;">Sales insights & trends</p>

<style>
  .card {
    padding: 20px;
    background: #F9F6F1;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    margin-bottom: 20px;
  }
  .card h3 {
    margin-bottom: 12px;
    color: #0A1F44;
  }
  .btn {
    padding: 6px 14px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    border: none;
  }
  .btn-primary {
    background-color: #0A1F44;
    color: #fff;
  }
  .btn-primary:hover {
    background-color: #14356b;
  }
  .btn-secondary {
    background-color: #e6ecf5;
    color: #0A1F44;
  }
  .btn-secondary:hover {
    background-color: #d0d7e6;
  }
  .invoice-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }
  .invoice-table th {
    background-color: #0A1F44;
    color: #fff;
    padding: 10px;
    text-align: left;
  }
  .invoice-table td {
    padding: 8px;
    border-bottom: 1px solid #ddd;
  }
  .invoice-table tr:hover {
    background-color: #eef2f9;
  }
  /* KPI cards */
  .kpi-card {
    text-align: center;
    background: #fff;
    border-radius: 10px;
    padding: 16px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    transition: transform 0.2s ease;
  }
  .kpi-card:hover {
    transform: translateY(-3px);
  }
  .kpi-card p {
    margin: 0;
    color: #6B7280;
    font-size: 13px;
  }
  .kpi-card h2 {
    margin: 6px 0 0;
    color: #0A1F44;
    font-size: 20px;
  }
  /* Insights list */
  .card ul {
    list-style: none;
    padding-left: 0;
  }
  .card ul li {
    padding: 6px 0;
    border-bottom: 1px solid #ddd;
    color: #333;
  }
</style>
<form method="post" action="{% url 'import_google_sheet' %}" style="margin-bottom:20px;">
  {% csrf_token %}
  <input type="url" name="sheet_url" placeholder="Paste Google Sheet link" class="form-input">
    <p style="color:#6B7280;font-size:13px;">
    Note: Google Sheet must be shared as <b>Anyone with link – Viewer</b>
    </p>

  <button type="submit" class="btn btn-primary">Import from Google Sheet</button>
</form>

<form method="post" action="{% url 'import_csv_file' %}" enctype="multipart/form-data" style="margin-bottom:20px;">
  {% csrf_token %}
  <input type="file" name="csv_file" accept=".csv" class="form-input">
  <button type="submit" class="btn btn-secondary">Upload CSV File</button>
  <p style="margin-top:6px;font-size:13px;">
  <a href="/static/templates/billing_import_template.csv" target="_blank">
    Download sample CSV template
  </a>
</p>

</form>

<form method="get" style="display:flex;gap:12px;margin-bottom:20px;">
  <input type="date" name="from_date" value="{{ from_date }}">
  <input type="date" name="to_date" value="{{ to_date }}">
  <button class="btn btn-primary">Apply</button>
</form>

<form method="get" style="margin-bottom:16px;">
  <input type="hidden" name="from_date" value="{{ from_date }}">
  <input type="hidden" name="to_date" value="{{ to_date }}">
  <button name="group" value="day" class="btn btn-secondary">Daily</button>
  <button name="group" value="month" class="btn btn-secondary">Monthly</button>
</form>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;">
  <div class="kpi-card"><p>Total Sales</p><h2>₹{{ overview.total_sales|floatformat:0 }}</h2></div>
  <div class="kpi-card"><p>Bills</p><h2>{{ overview.bill_count }}</h2></div>
  <div class="kpi-card"><p>Paid</p><h2>{{ overview.paid }}</h2></div>
  <div class="kpi-card"><p>Unpaid</p><h2>{{ overview.unpaid }}</h2></div>
</div>

<div class="card">
  <h3>Sales Trend</h3>
  <canvas id="salesChart"></canvas>
</div>

<div class="card">
  <h3>Top Selling Items</h3>
  <table class="invoice-table">
    <tr><th>Item</th><th>Qty</th><th>Revenue</th></tr>
    {% for item in top_items %}
    <tr>
      <td>{{ item.item_name }}</td>
      <td>{{ item.qty }}</td>
      <td>₹{{ item.revenue|floatformat:0 }}</td>
    </tr>
    {% empty %}
    <tr><td colspan="3">No data</td></tr>
    {% endfor %}
  </table>
</div>

<div class="card">
  <h3>Smart Insights</h3>
  <ul>
    {% for insight in insights %}
      <li>{{ insight }}</li>
    {% empty %}
      <li>No insights available</li>
    {% endfor %}
  </ul>
</div>

{{ chart_labels|json_script:"labels" }}
{{ chart_values|json_script:"values" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const labels = JSON.parse(document.getElementById("labels").textContent);
const values = JSON.parse(document.getElementById("values").textContent);

new Chart(document.getElementById("salesChart"), {
  type: "line",
  data: {
    labels: labels,
    datasets: [{
      label: "Sales",
      data: values,
      borderColor: "#0A1F44",
      backgroundColor: "rgba(10,31,68,0.1)",
      borderWidth: 2,
      tension: 0.3,
      fill: true
    }]
  },
  options: {
    plugins: {
      legend: { display: false }
    },
    scales: {
      y: { beginAtZero: true }
    }
  }
});
</script>

{% endblock %}
